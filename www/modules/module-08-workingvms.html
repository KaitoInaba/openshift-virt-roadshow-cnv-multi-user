<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Working with Virtual Machines and Applications :: Experience Red Hat OpenShift Virtualization</title>
    <link rel="prev" href="module-07-tempinst.html">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../_/css/site.css"><link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://demo.redhat.com/images/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar"  style="background-color: #131313 !important;">
    <div class="navbar-brand">
      <div style="display: flex; flex-direction:row; padding: 12px 32px; gap: 16px;">
        <img src="https://www.redhat.com/rhdc/managed-files/Red-Hat-Summit-logo.svg" alt="Red Hat Summit logo" width="90px" class="hero-summit-logo dx-block dx-mb-1">
        <img src="https://gpte-public.s3.amazonaws.com/rh-ansiblefest-2021-logo-pool-reverse-rgb_0.svg" alt="AnsibleFest logo" width="auto" class="hero-ansiblefest-logo dx-block dx-mb-2">
      </div>
      <a class="navbar-item site-title" target="__blank" style="color: #fff !important;" href="..">Experience Red Hat OpenShift Virtualization</a>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
      </div>
    </div>
  </nav>
</header>
    <div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title" style="display: none;"><a href="index.html" class=" query-params-link">Sample Module Title</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-01-intro.html">1. Virtual Machine Management </a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01-intro.html#create_project">Create a New Project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01-intro.html#create_vm">Create a Linux Virtual Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01-intro.html#admin_vms">Administering Virtual Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01-intro.html#vm_state">Controlling Virtual Machine State</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01-intro.html#live_migrate">Live Migrate a Virtual Machine</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-02-mtv.html">2. Migrating Existing Virtual Machines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-02-mtv.html#prerequisites">Prerequisites for Migrations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-02-mtv.html#migrating_vms">Migrating Virtual Machines from VMware</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-03-baremetal.html">3. Bare Metal Management </a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-03-baremetal.html#review_nodes">Review Nodes and Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-03-baremetal.html#review_hosts">Review Bare Metal Hosts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-03-baremetal.html#scaling_cluster">Scaling the Cluster with a New Bare Metal Host</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-04-storage.html">4. Storage Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-04-storage.html#examine_pvc">Examine the PVC for a VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-04-storage.html#managing_snapshots">Managing Snapshots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-04-storage.html#clone_vm">Clone a Virtual Machine</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-05-bcdr.html">5. Backup and Recovery for Virtual Machines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-05-bcdr.html#review_operator">Review the OADP Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-05-bcdr.html#create_backup">Create a Virtual Machine Backup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-05-bcdr.html#restore_backup">Restore From a Backup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-06-network.html">6. Network Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-06-network.html#create_netattach">Create a Network Attachment Definition</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-06-network.html#connect_external_net">Connect a Virtual Machine to an External Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-06-network.html#multinetwork_policy">Using a Multinetwork Policy</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-07-tempinst.html">7. Template and InstanceType Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-07-tempinst.html#clone_customize_template">Clone and Customize a Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-07-tempinst.html#create_win">Create a Windows VM Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-07-tempinst.html#instance_types">Introduction to Instance Types</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-08-workingvms.html">8. Working with Virtual Machines and Applications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#lb_concepts">Load Balancer Concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#lb_config">Load Balancer Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#service_route">Exposing an Application with a Service/Route</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#expose_db">Expose the Database Externally</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore" style="display: none;">
  <div class="context">
    <span class="title">Sample Module Title</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Sample Module Title</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="module-08-workingvms.html">8. Working with Virtual Machines and Applications</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Working with Virtual Machines and Applications</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section of our lab is dedicated to the Day-2 operations that many administrators would need to perform when working with virtual machines in their OpenShift Virtualization environment. We will make use of the understanding we have developed throughout this roadshow of how VMs operate in an OpenShift environment, and use those skills to complete the tasks in this section. In this particular case, we are going to work with the three virtual machines that we imported from VMware vSphere earlier in this roadshow, and we are going to make some minor configuration changes to enable the applications hosted on those servers to be accessed as they now run in OpenShift Virtualization. To accomplish this, we will install and configure a loadbalancer, and we will expose our applications using the service/route method that is the default when making use of the OpenShift SDN pod network so that the application is reachable from outside of the cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lb_concepts"><a class="anchor" href="#lb_concepts"></a>MetalLB concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this portion of the lab, we will review the MetalLB operator and understand how it exposes virtual machine hosted applications outside of the cluster.</p>
</div>
<div class="paragraph">
<p>Using MetalLB is valuable when you have a bare-metal cluster or a virtual infrastructure that is treated like bare-metal, and you want to ensure that there is fault-tolerant access to an application through an external IP address.</p>
</div>
<div class="paragraph">
<p>For MetalLB to meet this need, you must configure your networking infrastructure to ensure that the network traffic for the external IP address is routed from clients to the host network for the cluster.</p>
</div>
<div class="paragraph">
<p>It can operate in two modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>MetalLB operating in layer2 mode</strong> provides support for failover by utilizing a mechanism similar to IP failover. However, instead of relying on the virtual router redundancy protocol (VRRP) and keepalived, MetalLB leverages a gossip-based protocol to identify instances of node failure. When a failure is detected, another node assumes the role of the leader node, and a gratuitous ARP message is dispatched to broadcast this change.</p>
</li>
<li>
<p><strong>MetalLB operating in layer3 or border gateway protocol (BGP) mode</strong> delegates failure detection to the network. The BGP router or routers that the OpenShift nodes have established a connection with will identify any node failure and terminate the routes to that node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using MetalLB instead of IP failover is often preferable for ensuring high availability of pods and services.</p>
</div>
<div class="sect2">
<h3 id="_layer_2_mode"><a class="anchor" href="#_layer_2_mode"></a>Layer 2 mode</h3>
<div class="paragraph">
<p>In layer 2 mode, the speaker pod on one node announces the external IP address for a service to the host network. From a network perspective, the node appears to have multiple IP addresses assigned to a network interface.</p>
</div>
<div class="paragraph">
<p>In layer 2 mode, all traffic for a service IP address is routed through one node. After traffic enters the node, the service proxy for the CNI network provider distributes the traffic to all the pods for the service.</p>
</div>
<div class="paragraph">
<p>When a node becomes unavailable, failover is automatic. The speaker pods on the other nodes detect that a node is unavailable, and a new speaker pod on a surviving node will take ownership of the service IP address from the failed node.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<a class="image" href="module-08-workingvms/00_Layer2.png" target="blank"><img src="module-08-workingvms/00_Layer2.png" alt="00 Layer2" width="100%"></a>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_layer_3_bgp_mode"><a class="anchor" href="#_layer_3_bgp_mode"></a>Layer 3 (BGP) mode</h3>
<div class="paragraph">
<p>In BGP mode, by default, each speaker pod advertises the load balancer IP address for a service to each BGP peer. It is also possible to advertise the IPs coming from a given pool to a specific set of peers by adding an optional list of BGP peers. BGP peers are commonly network routers that are configured to use the BGP protocol. When a router receives traffic for the load balancer IP address, the router picks one of the nodes with a speaker pod that advertised the IP address. The router sends the traffic to that node. After traffic enters the node, the service proxy for the CNI network plugin distributes the traffic to all the pods for the service.</p>
</div>
<div class="paragraph">
<p>If a node becomes unavailable, the router then initiates a new connection with another node that has a speaker pod that is advertising the load balancer IP address.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<a class="image" href="module-08-workingvms/01_BGP.png" target="blank"><img src="module-08-workingvms/01_BGP.png" alt="01 BGP" width="100%"></a>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_review_the_metallb_operator"><a class="anchor" href="#_review_the_metallb_operator"></a>Review the MetalLB Operator</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to <strong>Operators</strong> &#8594; <strong>Installed Operators</strong>. Click on the the <strong>Project:</strong> dropdown and select the <strong>metallb-system</strong> namespace.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/02_Operator_Installed.png" target="blank"><img src="_images/module-08-workingvms/02_Operator_Installed.png" alt="02 Operator Installed" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Click on the operator and review the <strong>Provided APIs</strong> on the <strong>Details</strong> tab.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/03_Review_Operator.png" target="blank"><img src="_images/module-08-workingvms/03_Review_Operator.png" alt="03 Review Operator" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Select the tab <strong>MetalLB</strong> to ensure the deployment is installed and configured correctly</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/04_Review_MetalLB.png" target="blank"><img src="_images/module-08-workingvms/04_Review_MetalLB.png" alt="04 Review MetalLB" width="100%"></a>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lb_config"><a class="anchor" href="#lb_config"></a>Configure MetalLB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With our MetalLB application successfully installed it&#8217;s now time to configure it for our use.</p>
</div>
<div class="paragraph">
<p>For this portion of the lab, we will use the same network where the OpenShift Cluster nodes are located (<strong>192.168.123.0/24</strong>) and for this exercise we will reserve the IP range <strong>192.168.123.200-192.168.123.250</strong> to be used for load balanced services in the OpenShift cluster.</p>
</div>
<div class="sect2">
<h3 id="_create_ipaddress_pool"><a class="anchor" href="#_create_ipaddress_pool"></a>Create IPAddress Pool</h3>
<div class="paragraph">
<p>The first step is to create an IP address pool to assign IPs to applications to be accessed from outside our cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click on the tab for <strong>IPAddressPool</strong> click on the button for <strong>Create IPAddressPool</strong>.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/05_IPAddressPool.png" target="blank"><img src="_images/module-08-workingvms/05_IPAddressPool.png" alt="05 IPAddressPool" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Use the name <strong>ip-addresspool-webapp</strong> and under section <em>addresses</em>, remove any existing addresses and enter <strong>192.168.123.200-192.168.123.250</strong> as the address pool. When complete it should look similar to this image:</p>
<div class="imageblock unresolved">
<div class="content">
<a class="image" href="module-08-workingvms/06_MetalLB_IPAddressPool_Defined.png" target="blank"><img src="module-08-workingvms/06_MetalLB_IPAddressPool_Defined.png" alt="06 MetalLB IPAddressPool Defined" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Scroll down and press <strong>Create</strong>. You will be returned to the main operator page where you will see that the <strong>IPAddressPool</strong> is now created.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/07_IPAddressPool_Complete.png" target="blank"><img src="_images/module-08-workingvms/07_IPAddressPool_Complete.png" alt="07 IPAddressPool Complete" width="100%"></a>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configure_layer2_mode"><a class="anchor" href="#_configure_layer2_mode"></a>Configure Layer2 mode</h3>
<div class="paragraph">
<p>For this lab we will use MetalLB in layer2 mode, so we need to create the configuration.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Switch to the <strong>L2Advertisement</strong> tab (you may need to scroll the tab list to the right to see it) and press <strong>Create L2Advertisement</strong>.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/08_L2Advertisement.png" target="blank"><img src="_images/module-08-workingvms/08_L2Advertisement.png" alt="08 L2Advertisement" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Indicate the name <strong>l2-adv-webapp</strong> and under section <em>ipaddressPools</em> specify the value <strong>ip-addresspool-webapp</strong> as is shown in the following image:</p>
<div class="imageblock unresolved">
<div class="content">
<a class="image" href="module-08-workingvms/09_MetalLB_L2Advertisement.png" target="blank"><img src="module-08-workingvms/09_MetalLB_L2Advertisement.png" alt="09 MetalLB L2Advertisement" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Scroll down and press <strong>Create</strong>. You will be returned to the main operator page where you will see that the <strong>L2Advertisement</strong> is now created.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/10_L2Advertisement_Complete.png" target="blank"><img src="_images/module-08-workingvms/10_L2Advertisement_Complete.png" alt="10 L2Advertisement Complete" width="100%"></a>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>With MetalLB installed and configured we can now prepare to make the applications on our imported VM&#8217;s available from outside of the cluster.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service_route"><a class="anchor" href="#service_route"></a>Exposing an Application with a Service/Route</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, virtual machines are connected to the SDN, which is a convenient and easy way to give them access to the rest of the network, but can be challenging for the virtual machines, and other pods in the OpenShift cluster, to find and connect to the virtualized applications. To solve this, we will use a <strong>Service</strong> to balance connections across the two Windows-based web servers, and create a DNS entry for each service discovery, then create a <strong>Route</strong> to allow external clients to access the application hosted within the virtual machines.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you have not completed the module <strong>Migrating Existing Virtual Machines</strong>, it is recommended that you do that module first. If you have not completed it, or the migration process is still pending, you can use pre-existing virtual machines that have been prepared for you, which are available in the <strong>vmimported</strong> project. If you are using these pre-imported virtual machines, please replace all instances of the <strong>vmexamples</strong> namespace with <strong>vmimported</strong> in the examples below.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_introduction_to_services"><a class="anchor" href="#_introduction_to_services"></a>Introduction to Services</h3>
<div class="paragraph">
<p>The <strong>Service</strong> identifies the source/target for traffic, and directs clients to, the endpoints based on labels. Currently, the VMs do not have a label assigned yet.</p>
</div>
<div class="paragraph">
<p>In order to successfully associate the  VMs with the Service, we need to do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a label to the VMs. We will use the same label for both Windows IIS servers because they are both behind the same load balancer.</p>
</li>
<li>
<p>Create the service to make the two Windows IIS servers available for other workloads on the cluster. OpenShift will automatically make the load balancer internally accessible using the name of the Service as the DNS name.</p>
</li>
<li>
<p>Make the service available outside of OpenShift by creating a <strong>Route</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To begin, we&#8217;ll add labels to the virtual machines by modifying their definition in the OpenShift Virtualization GUI.</p>
</div>
</div>
<div class="sect2">
<h3 id="_label_the_virtual_machines"><a class="anchor" href="#_label_the_virtual_machines"></a>Label the virtual machines</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the OpenShift console, navigate to <strong>Virtualization</strong> &#8594; <strong>VirtualMachines</strong> and ensure the migrated VMs successfully imported and are running.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/11_Imported_VMs_List.png" target="blank"><img src="_images/module-08-workingvms/11_Imported_VMs_List.png" alt="11 Imported VMs List" width="100%"></a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ensure you select the correct project, <strong>vmexamples</strong> if you completed the <strong>Migrating Existing Virtual Machines</strong> module or <strong>vmimported</strong> if you did not.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Select to the <strong>winweb01</strong> VM and navigate to the <strong>YAML</strong> tab.</p>
</li>
<li>
<p>Find the <strong>spec:</strong> section and under the <strong>template.metadata</strong> add the following lines to <strong>labels</strong> section in the VM resources:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">env: webapp</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Make sure to get the indentation exactly right - just like in the screenshot below.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/12_Imported_VMs_YAML.png" target="blank"><img src="_images/module-08-workingvms/12_Imported_VMs_YAML.png" alt="12 Imported VMs YAML" width="100%"></a>
</div>
</div>
</li>
<li>
<p><strong>Repeat</strong> the process for the VM <strong>winweb02</strong>.</p>
</li>
<li>
<p>Start, or restart if already running, the <strong>winweb01</strong> and <strong>winweb02</strong> virtual machines.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ensure the VMs are properly working by accessing to the console tab of each VM.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_the_service"><a class="anchor" href="#_create_the_service"></a>Create the Service</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to <strong>Networking</strong> &#8594; <strong>Services</strong> and press <strong>Create Service</strong>.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/13_Navigate_Service.png" target="blank"><img src="_images/module-08-workingvms/13_Navigate_Service.png" alt="13 Navigate Service" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Replace the YAML with the following definition</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: webapp
  namespace: vmexamples
spec:
  selector:
    env: webapp
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Ensure the namespace with your virtual machines, <strong>vmexamples</strong> or <strong>vmimported</strong>, is the one used in the Service YAML.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/14_Service_YAML.png" target="blank"><img src="_images/module-08-workingvms/14_Service_YAML.png" alt="14 Service YAML" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Press <strong>Create</strong>.</p>
</li>
<li>
<p>From the details page for the newly created <strong>webapp</strong> Service, locate <strong>Pod selector</strong> link and click it.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/15_Imported_VMs_PodSelector.png" target="blank"><img src="_images/module-08-workingvms/15_Imported_VMs_PodSelector.png" alt="15 Imported VMs PodSelector" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Verify the two Windows VMs are properly identified and targeted by the Service.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/16_Imported_VMs_Pods.png" target="blank"><img src="_images/module-08-workingvms/16_Imported_VMs_Pods.png" alt="16 Imported VMs Pods" width="100%"></a>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_the_route"><a class="anchor" href="#_create_the_route"></a>Create the Route</h3>
<div class="paragraph">
<p>Now the Windows IIS servers are accessible from within the OpenShift cluster. Other virtual machines are able to access them using the DNS name <strong>webapp.vmexamples</strong>, which is determined by the name of the Service + the namespace. However, since these web servers are the front end to an application we want to be externally accessible, we will expose it using a <strong>Route</strong>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to <strong>Networking</strong> &#8594; <strong>Routes</strong> in the left navigation menu, verify that you&#8217;re using the correct project name. Press <strong>Create Route</strong>.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/17_Route_Navigation.png" target="blank"><img src="_images/module-08-workingvms/17_Route_Navigation.png" alt="17 Route Navigation" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Fill the form using the information below, press <strong>Create</strong> when done.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Name</strong>: <strong>route-webapp</strong></p>
</li>
<li>
<p><strong>Service</strong>: <strong>webapp</strong></p>
</li>
<li>
<p><strong>Target port</strong>: <strong>80 &#8594; 80 (TCP)</strong></p>
</li>
<li>
<p><strong>Secure Route</strong>: <strong>Enabled</strong></p>
</li>
<li>
<p><strong>TLS termination</strong>: <strong>Edge</strong></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="imageblock unresolved">
<div class="content">
<a class="image" href="module-08-workingvms/18_Create_Route.png" target="blank"><img src="module-08-workingvms/18_Create_Route.png" alt="18 Create Route" width="100%"></a>
</div>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the address shown in <strong>Location</strong> field</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/19_Route_Access.png" target="blank"><img src="_images/module-08-workingvms/19_Route_Access.png" alt="19 Route Access" width="100%"></a>
</div>
</div>
</li>
<li>
<p>When the page loads, you will see an error. This is because the Windows web servers are not able to currently connect to the database VM after it&#8217;s migration.</p>
<div class="imageblock unresolved">
<div class="content">
<a class="image" href="module-08-workingvms/20_WebApp_Error.png" target="blank"><img src="module-08-workingvms/20_WebApp_Error.png" alt="20 WebApp Error" width="100%"></a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To fix the connectivity issue, we need to create a Service for the database VM so that it can be accessed by the web servers.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Once again, navigate to <strong>Networking</strong> &#8594; <strong>Services</strong> and press <strong>Create Service</strong>. Replace the YAML with the following definition:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: database
  namespace: vmexamples
spec:
  selector:
    vm.kubevirt.io/name: database
  ports:
    - protocol: TCP
      port: 3306
      targetPort: 3306</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This time we used the name of the virtual machine to attach it to the service we are creating, since there is only one VM named <strong>database</strong> in the namespace with this name it is safe to do so without having to customize the YAML of the VM or rebooting the guest.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/21_Database_YAML.png" target="blank"><img src="_images/module-08-workingvms/21_Database_YAML.png" alt="21 Database YAML" width="100%"></a>
</div>
</div>
</li>
<li>
<p>When the YAML is pasted, click the <strong>Create</strong> button.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Ensure the namespace with your virtual machines, <strong>vmexamples</strong> or <strong>vmimported</strong> is the one used in the Service YAML.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Reload the webapp URL and expect to get the proper result</p>
<div class="imageblock unresolved">
<div class="content">
<a class="image" href="module-08-workingvms/22_WebApp_Success.png" target="blank"><img src="module-08-workingvms/22_WebApp_Success.png" alt="22 WebApp Success" width="100%"></a>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expose_db"><a class="anchor" href="#expose_db"></a>Expose the Database Externally</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you completed the <strong>Exposing an Application with a Service/Route</strong> module, the VM is currently accessible from inside the cluster using the Service previously created. In this task, we will expose port 3306 outside of the cluster, making the database available to other virtual machines and consumers not hosted in OpenShift.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to <strong>Networking</strong> &#8594; <strong>Services</strong> and select the project <strong>vmexamples</strong></p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/23_Create_Service_LB.png" target="blank"><img src="_images/module-08-workingvms/23_Create_Service_LB.png" alt="23 Create Service LB" width="100%"></a>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you did not complete the module <strong>Migrating Existing Virtual Machines</strong> you can use pre-existing virtual machines in the <strong>vmimported</strong> project. If you are using the pre-imported virtual machines, please replace all instances of <strong>vmexamples</strong> namespace with <strong>vmimported</strong>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Press <strong>Create Service</strong> and fill the form with the following code snippet:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: database-metallb
  namespace: vmexamples
spec:
  type: LoadBalancer
  selector:
    vm.kubevirt.io/name: database
  ports:
    - protocol: TCP
      port: 3306
      targetPort: 3306</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice the <strong>type</strong> indicated is <strong>LoadBalancer</strong>. Since this cluster has MetalLB installed, it will result in the specified port(s) exposed using that. There are other load balancer options available from partners such as F5, Nginx, and more.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/24_Database_LB_YAML.png" target="blank"><img src="_images/module-08-workingvms/24_Database_LB_YAML.png" alt="24 Database LB YAML" width="100%"></a>
</div>
</div>
</li>
<li>
<p>Press <strong>Create</strong> and review the <strong>Service</strong> created. Notice the IP address assigned to the load balancer is from the range specified earlier in the lab.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/25_Database_LB_Service_Created.png" target="blank"><img src="_images/module-08-workingvms/25_Database_LB_Service_Created.png" alt="25 Database LB Service Created" width="100%"></a>
</div>
</div>
</li>
<li>
<p>To verify connectivity to the database service via the external IP, use the terminal to the right authenticate to the database at it&#8217;s exposed LB address with the following credentials</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Username</strong>: <strong>root</strong></p>
</li>
<li>
<p><strong>Password</strong>: <strong>R3dh4t1!</strong></p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mysql -u root -p -h 192.168.123.202</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be sure to replace the ip address in the sample above with the address being advertised by MetalLB.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When successful, you should be able to login to the database and view the mysql prompt.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/module-08-workingvms/26_DB_Login.png" target="blank"><img src="_images/module-08-workingvms/26_DB_Login.png" alt="26 DB Login" width="100%"></a>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module you were able to experience working with the virtual machines that you migrated into the OpenShift Virtualization environment from VMware vSphere by making them accessible outside of the cluster in different manners.</p>
</div>
<div class="paragraph">
<p>I hope you have enjoyed the OpenShift Virtualization Roadshow and this lab that accompanied it. Please fill out the survey link that your proctor has made available to provide feedback on your experience.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="module-07-tempinst.html" class="query-params-link">7. Template and InstanceType Management</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a href="https://demo.redhat.com" target="_blank" class="poweredBy"><p>Powered by</p><div class="labInfo_poweredBy" style="display: block; width: 260px;"><svg class="labInfo_poweredByLogo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739"><g fill="#111"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#111"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#111" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg></div></a>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
