= Template Management

== Introduction

Preconfigured Red Hat virtual machine templates are listed in the *Virtualization* -> *Templates* page. These templates are available for different versions of Red Hat Enterprise Linux, Fedora, Centos, Microsoft Windows Desktop, and Microsoft Windows Server editions. Each Red Hat virtual machine template is preconfigured with an operating system image, the default settings for the operating system, the flavor (CPU and memory), and the workload type (server).

The *Templates* page displays four types of virtual machine templates:

* *Red Hat Supported* templates are fully supported by Red Hat.
* *User Supported* templates are *Red Hat Supported* templates that were cloned and created by users.
* *Red Hat Provided* templates have limited support from Red Hat.
* *User Provided* templates are *Red Hat Provided* templates that were cloned and created by users.

[[create_template]]
== Create a New Template

. Navigate to *Virtualization* -> *Templates* and select *All projects*
+
image::module-04/01_Template_List.png[link=self, window=blank, width=100%]

. Press *Create Template* and review auto filled YAML code
+
image::module-04/02_Template_YAML.png[link=self, window=blank, width=100%]
+
[NOTE]
This default template is using a container disk to run a VM. The data will be ephemeral.
+
. Scroll down and check the parameters for the template, notice it will auto-generate both a name for the VM, and a password.
+
image::module-04/03_Template_YAML_Parameters.png[link=self, window=blank, width=100%]
+
. Press *Create* and review the template details
+
image::module-04/04_Template_Details.png[link=self, window=blank, width=100%]
+
. Navigate to *Virtualization* -> *Catalog* and click on *User templates* on the left. Select the project `vmexamples`
+
image::module-04/05_Catalog.png[link=self, window=blank, width=100%]
+
. Click on the tile for the `example` template to bring up it's quick configuration screen. On this screen specify the name `fedora03` and the password `r3dh4t1!`. Press *Quick create VirtualMachine*
+
image::module-04/06_Catalog_Create_VM.png[link=self, window=blank, width=100%]
+
. When the VM is created we are taken to the Overview screen. You can see that it's created using our `example` template
+
image::module-04/07_Catalog_Create_VM_Overview.png[link=self, window=blank, width=100%]
+
. Navigate to tab *Configuration* and subtab *Storage*. Review that the VM was created with an ephemeral container disk as the template defined.
+
image::module-04/08_Ephemeral_Disk.png[link=self, window=blank, width=100%]
+
. Using the *Actions* menu, delete the VM.

== Create a Windows Virtual Machine

In this segment, we will install Microsoft Windows Server 2019 using an ISO hosted on a web server. This represents one way to install an operating system to a virtual machine that takes advantage of the ability to source disks from many locations, including a web server, object storage, or other persistent volumes in the cluster.

This process can be streamlined after the initial operating system installation by creating a template from the virtual machine. The specific process for preparing the guest operating system to be used as a template will vary, be sure to follow your organization's guidelines and requirements when preparing a template OS.

. From the left menu, navigate to *Virtualization* -> *Catalog*, and click on the *Template catalog* tab near the top..
+
image::module-04/09_Template_Catalog.png[link=self, window=blank, width=100%]
+
. Scroll down until you find the *Microsoft Windows Server 2019 VM* tile.
image::module-04/10_Windows_2k19_Tile.png[link=self, window=blank, width=100%]

. A dialog will appear showing the default configuration related to the template.
+
NOTE: Notice that there is no option to quick create this VM, and we must customize the VM to fit our needs.
+
image::module-04/11_Windows_2k19_Dialog.png[link=self, window=blank, width=100%]
+
. In this dialog:
.. Specify the name `windows`
.. Enable the checkbox *Boot from CD* and specify the url: http://192.168.123.100:81/Windows2019.iso
.. Reduce the CD disk size to *5 GiB*.
.. Keep the `Disk source` size disk to the default value *60 GiB*
.. Ensure the `Mount Windows drivers disk` checkbox is enabled. **This is required to install Windows systems, which will provide the drivers for VirtIO.**
+
image::module-04/12_Windows_2k19_Parameters.png[link=self, window=blank, width=100%]
+
. With the options filled out, we want to click on the *Customize VirtualMachine* button at the bottom to continue configuring our Template.
+
. On the *Customize and create VirtualMachine screen, click on the *Scripts* tab, and then scroll down to the *Sysprep* section and click on the *Edit* button.
image::module-04/13_Customize_Scripts.png[link=self, window=blank, width=100%]
+
. A new window will pop up for you to create *Sysprep* actions for your new template.
+
image::module-04/14_Sysprep.png[link=self, window=blank, width=100%]
+
. Copy and paste the following code block into the `autounattend.xml` section:
+
[source,xml,role=copy]
----
<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:schemas-microsoft-com:unattend">
  <settings pass="windowsPE">
    <component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <DiskConfiguration>
        <Disk wcm:action="add">
          <CreatePartitions>
            <CreatePartition wcm:action="add">
              <Order>1</Order>
              <Extend>true</Extend>
              <Type>Primary</Type>
            </CreatePartition>
          </CreatePartitions>
          <ModifyPartitions>
            <ModifyPartition wcm:action="add">
              <Active>true</Active>
              <Format>NTFS</Format>
              <Label>System</Label>
              <Order>1</Order>
              <PartitionID>1</PartitionID>
            </ModifyPartition>
          </ModifyPartitions>
          <DiskID>0</DiskID>
          <WillWipeDisk>true</WillWipeDisk>
        </Disk>
      </DiskConfiguration>
      <ImageInstall>
        <OSImage>
          <InstallFrom>
            <MetaData wcm:action="add">
              <Key>/IMAGE/NAME</Key>
              <Value>Windows Server 2019 SERVERSTANDARD</Value>
            </MetaData>
          </InstallFrom>
          <InstallTo>
            <DiskID>0</DiskID>
            <PartitionID>1</PartitionID>
          </InstallTo>
        </OSImage>
      </ImageInstall>
      <UserData>
        <AcceptEula>true</AcceptEula>
        <FullName>Administrator</FullName>
        <Organization>My Organization</Organization>
      </UserData>
      <EnableFirewall>false</EnableFirewall>
    </component>
    <component name="Microsoft-Windows-International-Core-WinPE" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <SetupUILanguage>
        <UILanguage>en-US</UILanguage>
      </SetupUILanguage>
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
  </settings>
  <settings pass="offlineServicing">
    <component name="Microsoft-Windows-LUA-Settings" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <EnableLUA>false</EnableLUA>
    </component>
  </settings>
  <settings pass="specialize">
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
  <settings pass="oobeSystem">
    <component name="Microsoft-Windows-International-Core" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
</unattend>
----
+
. Once the code is pasted, click the *Save* button on the dialog.
+
image::module-04/15_Windows_2k19_Sysprep.png[link=self, window=blank, width=100%]
+
. You will be returned to the *Customize and create Virtual Machine* screen, Click on the *Create VirtualMachine* button at the bottom.
+

// Pick Up Here, Boot Source Issue -- AC
. The Virtual Machine will start the provisioning process by downloading the ISO image, configuring, and starting the instance.
+
image::module-04/19_Windows_2k9_Provisioning.png[link=self, window=blank, width=100%]
+
. After a few minutes, the Virtual VM will be in `Running` status. Switch to the *Console* tab:
+
image::module-04/20_Windows_2k9_Console.png[link=self, window=blank, width=100%]
+
[IMPORTANT]
The VM is marked as "Not migratable" because a CD-ROM disk is attached. 

== Summary

In this section we learned how to modify an existing template, and how to create one that we could use to easily deploy Windows virtual machines on demand.
